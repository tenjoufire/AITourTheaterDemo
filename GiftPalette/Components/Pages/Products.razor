@page "/products"
@page "/商品一覧"
@using GiftPalette.Components.Shared
@inject IProductService ProductService
@inject ICartService CartService
@rendermode InteractiveServer

<PageTitle>商品一覧 - GiftPalette</PageTitle>
<link href="~/css/products.css" rel="stylesheet" />

<div class="products-container">
    @if (loading)
    {
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>商品を読み込み中...</p>
        </div>
    }
    else if (products.Count == 0)
    {
        <div class="empty-state">
            <p>商品が見つかりませんでした。</p>
        </div>
    }
    else
    {
        <div class="products-header">
            <h1 class="products-title">すべての商品</h1>
            <p class="products-count">@filteredProducts.Count 件の商品が見つかりました</p>
        </div>

        <div class="category-filter">
            <button class="filter-btn @(selectedCategory == "" ? "active" : "")" @onclick="@(() => FilterByCategory(""))">
                すべて
            </button>
            @foreach (var category in categories)
            {
                <button class="filter-btn @(selectedCategory == category ? "active" : "")" @onclick="@(() => FilterByCategory(category))">
                    @category
                </button>
            }
        </div>

        <div class="products-grid">
            @foreach (var product in filteredProducts)
            {
                <div class="product-card">
                    <div class="product-image">
                        <img src="@product.ImageUrl" alt="@product.Name" />
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">@product.Name</h3>
                        <p class="product-description">@product.Description</p>
                        <div class="product-details">
                            <div class="product-category">@product.Category</div>
                            <div class="product-price">¥@product.Price.ToString("N0")</div>
                        </div>
                        <div class="product-stock">在庫あり (@product.Stock 個)</div>
                        <div class="product-actions">
                            @if (product.IsAvailable && product.Stock > 0)
                            {
                                <button class="add-to-cart-btn" @onclick="@(() => AddToCart(product.Id))" disabled="@isAddingToCart">
                                    @if (isAddingToCart)
                                    {
                                        <span>追加中...</span>
                                    }
                                    else
                                    {
                                        <span>カートに追加</span>
                                    }
                                </button>
                            }
                            else
                            {
                                <button class="add-to-cart-btn disabled" disabled>
                                    在庫切れ
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<ToastNotification Title="@ToastTitle" Message="@ToastMessage" ShowToast="@ShowToast" ShowToastChanged="@((bool value) => ShowToast = value)" />

@code {
    private List<Product> products = new();
    private List<Product> filteredProducts = new();
    private List<string> categories = new();
    private string selectedCategory = "";
    private bool loading = true;
    private bool isAddingToCart = false;
    private bool ShowToast = false;
    private string ToastTitle = "";
    private string ToastMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        loading = true;
        products = await ProductService.GetProductsAsync();
        
        categories = products.Select(p => p.Category).Distinct().OrderBy(c => c).ToList();
        filteredProducts = products;
        
        loading = false;
    }

    private void FilterByCategory(string category)
    {
        selectedCategory = category;
        if (string.IsNullOrEmpty(category))
        {
            filteredProducts = products;
        }
        else
        {
            filteredProducts = products.Where(p => p.Category == category).ToList();
        }
    }

    private async Task AddToCart(int productId)
    {
        isAddingToCart = true;
        try
        {
            await CartService.AddToCartAsync(productId, 1);
            var product = products.FirstOrDefault(p => p.Id == productId);
            ToastTitle = "カート追加";
            ToastMessage = $"{product?.Name} がカートに追加されました！";
            ShowToast = true;
        }
        catch (Exception ex)
        {
            ToastTitle = "エラー";
            ToastMessage = "カートへの追加に失敗しました。";
            ShowToast = true;
            Console.WriteLine($"Error adding to cart: {ex.Message}");
        }
        finally
        {
            isAddingToCart = false;
        }
    }
}