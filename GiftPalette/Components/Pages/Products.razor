@page "/products"
@page "/商品一覧"
@using GiftPalette.Components.Shared
@inject IProductService ProductService
@inject ICartService CartService
@rendermode InteractiveServer

<PageTitle>商品一覧 - GiftPalette</PageTitle>
<link href="~/css/products.css" rel="stylesheet" />

<div class="products-container">
    @if (loading)
    {
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>商品を読み込み中...</p>
        </div>
    }
    else if (products.Count == 0)
    {
        <div class="empty-state">
            <p>商品が見つかりませんでした。</p>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="products-title">すべての商品</h1>
            <span class="text-muted">@filteredProducts.Count 件の商品が見つかりました</span>
        </div>

        <div class="category-filter">
            <button class="btn btn-outline-primary filter-btn @(selectedCategory == "" ? "active" : "")" @onclick="@(() => FilterByCategory(""))">
                すべて
            </button>
            @foreach (var category in categories)
            {
                <button class="btn btn-outline-primary filter-btn @(selectedCategory == category ? "active" : "")" @onclick="@(() => FilterByCategory(category))">
                    @category
                </button>
            }
        </div>

        <div class="row">
            @foreach (var product in filteredProducts)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <img src="@product.ImageUrl" class="card-img-top" alt="@product.Name" style="height: 200px; object-fit: contain;">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@product.Name</h5>
                            <p class="card-text flex-grow-1">@product.Description</p>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="h5 text-primary">¥@product.Price.ToString("N0")</span>
                                    <small class="text-muted">@product.Category</small>
                                </div>
                                @if (product.IsAvailable && product.Stock > 0)
                                {
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-success">在庫あり (@product.Stock 個)</small>
                                        <button class="btn btn-primary" @onclick="@(() => AddToCart(product.Id))" disabled="@isAddingToCart">
                                            @if (isAddingToCart)
                                            {
                                                <span>追加中...</span>
                                            }
                                            else
                                            {
                                                <span>カートに追加</span>
                                            }
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex justify-content-center">
                                        <span class="badge bg-secondary">在庫切れ</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<ToastNotification Title="@ToastTitle" Message="@ToastMessage" ShowToast="@ShowToast" ShowToastChanged="@((bool value) => ShowToast = value)" />

@code {
    private List<Product> products = new();
    private List<Product> filteredProducts = new();
    private List<string> categories = new();
    private string selectedCategory = "";
    private bool loading = true;
    private bool isAddingToCart = false;
    private bool ShowToast = false;
    private string ToastTitle = "";
    private string ToastMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        loading = true;
        products = await ProductService.GetProductsAsync();
        
        categories = products.Select(p => p.Category).Distinct().OrderBy(c => c).ToList();
        filteredProducts = products;
        
        loading = false;
    }

    private void FilterByCategory(string category)
    {
        selectedCategory = category;
        if (string.IsNullOrEmpty(category))
        {
            filteredProducts = products;
        }
        else
        {
            filteredProducts = products.Where(p => p.Category == category).ToList();
        }
    }

    private async Task AddToCart(int productId)
    {
        isAddingToCart = true;
        try
        {
            await CartService.AddToCartAsync(productId, 1);
            var product = products.FirstOrDefault(p => p.Id == productId);
            ToastTitle = "カート追加";
            ToastMessage = $"{product?.Name} がカートに追加されました！";
            ShowToast = true;
        }
        catch (Exception ex)
        {
            ToastTitle = "エラー";
            ToastMessage = "カートへの追加に失敗しました。";
            ShowToast = true;
            Console.WriteLine($"Error adding to cart: {ex.Message}");
        }
        finally
        {
            isAddingToCart = false;
        }
    }
}